<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Council - DB Browser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background: #f3f4f6; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #111827; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        select, input, button { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
        button { background: #2563eb; color: white; border: none; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .query-box { width: 100%; margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; resize: vertical; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; }
        tr:hover { background: #f9fafb; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .error { color: #dc2626; background: #fee2e2; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: none; }
        pre { white-space: pre-wrap; word-break: break-all; max-width: 300px; max-height: 100px; overflow-y: auto; margin: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Database Browser</h1>
        
        <div id="error" class="error"></div>
        
        <div class="controls">
            <select id="tableSelect" onchange="loadTable()">
                <option value="">Select a table...</option>
            </select>
            <button onclick="refreshTables()">Refresh Tables</button>
            <button onclick="toggleQueryMode()">Toggle SQL Mode</button>
        </div>
        
        <div id="querySection" style="display: none;" class="query-box">
            <textarea id="sqlQuery" placeholder="SELECT * FROM unified_models LIMIT 10"></textarea>
            <div style="margin-top: 10px;">
                <button onclick="runQuery()">Run Query</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevBtn" onclick="prevPage()">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextBtn" onclick="nextPage()">Next</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let currentTable = '';
        let currentPage = 1;
        let totalPages = 1;
        let isQueryMode = false;

        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API Error');
                }
                return await response.json();
            } catch (err) {
                showError(err.message);
                throw err;
            }
        }

        function showError(msg) {
            const el = document.getElementById('error');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        async function refreshTables() {
            try {
                const data = await fetchAPI('/api/admin/db/tables');
                const select = document.getElementById('tableSelect');
                select.innerHTML = '<option value="">Select a table...</option>';
                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function loadTable(page = 1) {
            const table = document.getElementById('tableSelect').value;
            if (!table) return;
            
            currentTable = table;
            currentPage = page;
            
            try {
                const data = await fetchAPI(`/api/admin/db/table/${table}?page=${page}`);
                renderTable(data.data);
                
                // Update pagination
                totalPages = data.total_pages;
                document.getElementById('pageInfo').textContent = `Page ${data.page} of ${data.total_pages} (${data.total_count} rows)`;
                document.getElementById('prevBtn').disabled = data.page <= 1;
                document.getElementById('nextBtn').disabled = data.page >= data.total_pages;
                document.getElementById('pagination').style.display = 'flex';
                document.getElementById('querySection').style.display = 'none';
            } catch (err) {
                console.error(err);
            }
        }

        function renderTable(rows) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%">No data found</td></tr>';
                return;
            }
            
            // Headers
            const headers = Object.keys(rows[0]);
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                thead.appendChild(th);
            });
            
            // Rows
            rows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    const val = row[h];
                    if (typeof val === 'object' && val !== null) {
                        td.innerHTML = `<pre>${JSON.stringify(val, null, 2)}</pre>`;
                    } else {
                        td.textContent = val !== null ? val : 'NULL';
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        async function runQuery() {
            const sql = document.getElementById('sqlQuery').value;
            if (!sql) return;
            
            try {
                const data = await fetchAPI('/api/admin/db/sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });
                renderTable(data.data);
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('pageInfo').textContent = `${data.count} results`;
            } catch (err) {
                console.error(err);
            }
        }

        function toggleQueryMode() {
            isQueryMode = !isQueryMode;
            document.getElementById('querySection').style.display = isQueryMode ? 'block' : 'none';
        }

        function prevPage() {
            if (currentPage > 1) loadTable(currentPage - 1);
        }

        function nextPage() {
            if (currentPage < totalPages) loadTable(currentPage + 1);
        }

        // Init
        refreshTables();
    </script>
</body>
</html>